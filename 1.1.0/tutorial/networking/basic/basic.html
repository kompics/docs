

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Basic Networking &mdash; Kompics 1.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Virtual Networks" href="../virtual/virtual.html" />
    <link rel="prev" title="Networking" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Kompics
          

          
            
            <img src="../../../_static/kompicslogo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Kompics Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../basics/basics.html">Kompics Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../timers/timers.html">Timers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Networking</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Basic Networking</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#messages-addresses-and-headers">Messages, Addresses, and Headers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#serialisation">Serialisation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#distributed-pingpong">Distributed PingPong</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cleanup-config-files-classmatchers-and-assembly">Cleanup: Config files, ClassMatchers, and Assembly</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../virtual/virtual.html">Virtual Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nat/nat.html">NAT Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../simulation/index.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../scala/index.html">Kompics Scala</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/index.html">Kompics Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project/index.html">Project Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javadoc/modules.html">Javadoc</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Kompics</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Kompics Tutorial</a> &raquo;</li>
        
          <li><a href="../index.html">Networking</a> &raquo;</li>
        
      <li>Basic Networking</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/tutorial/networking/basic/basic.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="basic-networking">
<span id="basicnetworking"></span><h1>Basic Networking<a class="headerlink" href="#basic-networking" title="Permalink to this headline">¶</a></h1>
<p>As opposed to many other languages and frameworks commonly used for writing distributed applications (e.g., <a class="reference external" href="http://www.erlang.se">Erlang</a> and <a class="reference external" href="http://akka.io/">Akka</a>) in Kompics networking is not handled transparently. Instead Kompics requires explicit addressing of <em>messages</em>, that is events that (could) go over the network. There are two reasons for this design: First of all, events in Kompics are normally not messages in that they are not addressed, but follow channels instead. So the logical extension of this pattern to a distributed setting would be to create cross-network channels manually. However, this would be very unintuitive for a programmer as it would be way too static a setup. And further, and this is the second reason, it would be misleading to assume that local events and network messages have the same semantics. Network messages have to deal with unavailable nodes, connection loss, partitions, and so on. Instead of trying to force a one-fits-all solution onto the programmer, as systems like Akka and the venerable <a class="reference external" href="http://docs.oracle.com/javase/7/docs/technotes/guides/rmi/">Java RMI</a> do, Kompics exposes these challenges and allows system designers to find application appropriate solutions.</p>
<p>The following sections will describe the Kompics <code class="docutils literal notranslate"><span class="pre">Network</span></code> port, and its default implementation <code class="docutils literal notranslate"><span class="pre">NettyNetwork</span></code>. The latter also features a serialisation framework, which will be described as well in this part of the tutorial. As our example program we will stick to the <em>PingPong</em> code from the previous tutorials and extend it with networking capabilities.</p>
<p>The examples in this tutorial require two new dependencies in the <code class="file docutils literal notranslate"><span class="pre">pom.xml</span></code> file:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>se.sics.kompics.basic<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>kompics-port-network<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${kompics.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>se.sics.kompics.basic<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>kompics-component-netty-network<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${kompics.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="section" id="messages-addresses-and-headers">
<h2>Messages, Addresses, and Headers<a class="headerlink" href="#messages-addresses-and-headers" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../../../javadoc/port-network/se/sics/kompics/network/Network.html#se.sics.kompics.network.Network" title="se.sics.kompics.network.Network"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.Network</span></code></a> only allows three kinds of events: <a class="reference internal" href="../../../javadoc/port-network/se/sics/kompics/network/Msg.html#se.sics.kompics.network.Msg" title="se.sics.kompics.network.Msg"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.Msg</span></code></a> may pass in both directions (indication and request), while <a class="reference internal" href="../../../javadoc/port-network/se/sics/kompics/network/MessageNotify-Req.html#se.sics.kompics.network.MessageNotify.Req" title="se.sics.kompics.network.MessageNotify.Req"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.MessageNotify.Req</span></code></a> is a request and <a class="reference internal" href="../../../javadoc/port-network/se/sics/kompics/network/MessageNotify-Resp.html#se.sics.kompics.network.MessageNotify.Resp" title="se.sics.kompics.network.MessageNotify.Resp"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.MessageNotify.Resp</span></code></a> is an indication. The latter two can be used to ask the <code class="docutils literal notranslate"><span class="pre">Network</span></code> service for feedback about whether or not a specific message was sent, how long it took, and how big the serialised version was. This is convenient for systems that need to keep statistics about their messages, or where resources should be freed as soon as a message crosses the wire.
All messages that go over the network have to implement the <code class="docutils literal notranslate"><span class="pre">Msg</span></code> interface, which merely stipulates that a message has to have some kind of header (<a class="reference internal" href="../../../javadoc/port-network/se/sics/kompics/network/Header.html#se.sics.kompics.network.Header" title="se.sics.kompics.network.Header"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.Header</span></code></a>). The deprecated methods still need to be implemented for backwards compatibility, but should simply forward fields from the <code class="docutils literal notranslate"><span class="pre">Header</span></code>.
The header itself requires three fields:</p>
<blockquote>
<div><ol class="arabic simple">
<li>A <strong>source</strong> address, which on the sender side is typically the <em>self</em> address of the node, and on the receiver side refers to the sender.</li>
<li>A <strong>destination</strong> address, which tells the network on the sender side, where the message should go, and is typically the <em>self</em> address on the receiver side.</li>
<li>The <strong>transport</strong> protocol to be used for the message. There is no requirement for all <code class="docutils literal notranslate"><span class="pre">Network</span></code> implementations to implement all possible protocols. <code class="docutils literal notranslate"><span class="pre">NettyNetwork</span></code> implements <code class="docutils literal notranslate"><span class="pre">TCP</span></code>, <code class="docutils literal notranslate"><span class="pre">UDP</span></code>, and <code class="docutils literal notranslate"><span class="pre">UDT</span></code> only.</li>
</ol>
</div></blockquote>
<p>The <a class="reference internal" href="../../../javadoc/port-network/se/sics/kompics/network/Address.html#se.sics.kompics.network.Address" title="se.sics.kompics.network.Address"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.Address</span></code></a> interface has four required methods:</p>
<blockquote>
<div><ol class="arabic simple">
<li>IP and</li>
<li>port are pretty self explanatory.</li>
<li><code class="docutils literal notranslate"><span class="pre">asSocket</span></code> should get a combined represenation of IP and port. It is strongly recommended to keep the internal representation of the address as <code class="docutils literal notranslate"><span class="pre">InetSocketAddress</span></code>, since this method will be called a lot more often than the first two, and creating a new object for it on the fly is rather expensive.</li>
<li><code class="docutils literal notranslate"><span class="pre">sameHostAs</span></code> is used for avoiding serialisation overhead when the message would end up in the same JVM anyway. This can be used for local addressing of components and is typically important for <em>virtual nodes</em> (see section <a class="reference internal" href="../virtual/virtual.html#virtualnetwork"><span class="std std-ref">Virtual Networks</span></a>) where components on the same JVM will often communicate via the network port.</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">None of the interface presented above make any requirements as to the (im-)mutability of their fields. It is typically recommended to make all of them immutable. However, certain setups will require things like mutable headers, for example routing might be implemented in such a way.</p>
</div>
<p>Since almost all application will need custom fields in addition to the fields in the <code class="docutils literal notranslate"><span class="pre">Msg</span></code>, <code class="docutils literal notranslate"><span class="pre">Header</span></code>, or <code class="docutils literal notranslate"><span class="pre">Address</span></code> interfaces, almost everyone will want to write their own implementations. However, if that should not be the case, a simple default implementation can be found in <a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/DirectMessage.html#se.sics.kompics.network.netty.DirectMessage" title="se.sics.kompics.network.netty.DirectMessage"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.DirectMessage</span></code></a>, <a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/DirectHeader.html#se.sics.kompics.network.netty.DirectHeader" title="se.sics.kompics.network.netty.DirectHeader"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.DirectHeader</span></code></a>, and <a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/NettyAddress.html#se.sics.kompics.network.netty.NettyAddress" title="se.sics.kompics.network.netty.NettyAddress"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.NettyAddress</span></code></a>. For the purpose of this tutorial however, we will write our own, which we will prefix with <strong>T</strong> (for <em>Tutorial</em>) to avoid naming conflicts, since Java lacks support for import aliases.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Address</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TAddress</span> <span class="kd">implements</span> <span class="n">Address</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">InetSocketAddress</span> <span class="n">isa</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TAddress</span><span class="o">(</span><span class="n">InetAddress</span> <span class="n">addr</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">InetAddress</span> <span class="nf">getIp</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">isa</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getPort</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">isa</span><span class="o">.</span><span class="na">getPort</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">InetSocketAddress</span> <span class="nf">asSocket</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">isa</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">sameHostAs</span><span class="o">(</span><span class="n">Address</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">isa</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">asSocket</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// Not required but strongly recommended</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">isa</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="n">hash</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">*</span> <span class="n">hash</span> <span class="o">+</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">isa</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">isa</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">TAddress</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">isa</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">isa</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">isa</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">isa</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">isa</span><span class="o">)))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Header</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">THeader</span> <span class="kd">implements</span> <span class="n">Header</span><span class="o">&lt;</span><span class="n">TAddress</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">src</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">dst</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Transport</span> <span class="n">proto</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">THeader</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">src</span><span class="o">,</span> <span class="n">TAddress</span> <span class="n">dst</span><span class="o">,</span> <span class="n">Transport</span> <span class="n">proto</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">proto</span> <span class="o">=</span> <span class="n">proto</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TAddress</span> <span class="nf">getSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">src</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TAddress</span> <span class="nf">getDestination</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dst</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Transport</span> <span class="nf">getProtocol</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">proto</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Address</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Header</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Msg</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TMessage</span> <span class="kd">implements</span> <span class="n">Msg</span><span class="o">&lt;</span><span class="n">TAddress</span><span class="o">,</span> <span class="n">THeader</span><span class="o">&gt;</span> <span class="o">{</span>
    
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">THeader</span> <span class="n">header</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">TMessage</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">src</span><span class="o">,</span> <span class="n">TAddress</span> <span class="n">dst</span><span class="o">,</span> <span class="n">Transport</span> <span class="n">protocol</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">header</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THeader</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">dst</span><span class="o">,</span> <span class="n">protocol</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">THeader</span> <span class="nf">getHeader</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TAddress</span> <span class="nf">getSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">.</span><span class="na">src</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TAddress</span> <span class="nf">getDestination</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">.</span><span class="na">dst</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Transport</span> <span class="nf">getProtocol</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">.</span><span class="na">proto</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</pre></div>
</div>
<p>For our <em>PingPong</em> example we shall have both <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> extend <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> instead of the direct request-response. We also hard-code <code class="docutils literal notranslate"><span class="pre">TCP</span></code> as protocol for both for now.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ping</span> <span class="kd">extends</span> <span class="n">TMessage</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">Ping</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">src</span><span class="o">,</span> <span class="n">TAddress</span> <span class="n">dst</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">dst</span><span class="o">,</span> <span class="n">Transport</span><span class="o">.</span><span class="na">TCP</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pong</span> <span class="kd">extends</span> <span class="n">TMessage</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">Pong</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">src</span><span class="o">,</span> <span class="n">TAddress</span> <span class="n">dst</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">dst</span><span class="o">,</span> <span class="n">Transport</span><span class="o">.</span><span class="na">TCP</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now we need to change the <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> and the <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> to take a <em>self</em> address as init-parameter, require the <code class="docutils literal notranslate"><span class="pre">Network</span></code> port and feed the new constructor arguments to the <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> classes. Since we are using the network port now for the ping-pong, we can remove the requirement for the <code class="docutils literal notranslate"><span class="pre">PingPongPort</span></code>. In this first example we’ll make our lives somewhat simple and use the <em>self</em> address as source and destination for both classes. This corresponds to the local reflection example mentioned above.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.ComponentDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Positive</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Start</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Network</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pinger</span> <span class="kd">extends</span> <span class="n">ComponentDefinition</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Pinger</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

		<span class="n">Positive</span><span class="o">&lt;</span><span class="n">Network</span><span class="o">&gt;</span> <span class="n">net</span> <span class="o">=</span> <span class="n">requires</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">Positive</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">&gt;</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">requires</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

		<span class="kd">private</span> <span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="kd">private</span> <span class="n">UUID</span> <span class="n">timerId</span><span class="o">;</span>
		<span class="kd">private</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>

		<span class="kd">public</span> <span class="nf">Pinger</span><span class="o">(</span><span class="n">Init</span> <span class="n">init</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">Handler</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span> <span class="n">startHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;(){</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Start</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">SchedulePeriodicTimeout</span> <span class="n">spt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SchedulePeriodicTimeout</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
				<span class="n">PingTimeout</span> <span class="n">timeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PingTimeout</span><span class="o">(</span><span class="n">spt</span><span class="o">);</span>
				<span class="n">spt</span><span class="o">.</span><span class="na">setTimeoutEvent</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
				<span class="n">trigger</span><span class="o">(</span><span class="n">spt</span><span class="o">,</span> <span class="n">timer</span><span class="o">);</span>
				<span class="n">timerId</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">.</span><span class="na">getTimeoutId</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">};</span>
		<span class="n">Handler</span><span class="o">&lt;</span><span class="n">Pong</span><span class="o">&gt;</span> <span class="n">pongHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">Pong</span><span class="o">&gt;(){</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Pong</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">counter</span><span class="o">++;</span>
				<span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Got Pong #{}!&quot;</span><span class="o">,</span> <span class="n">counter</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">};</span>
		<span class="n">Handler</span><span class="o">&lt;</span><span class="n">PingTimeout</span><span class="o">&gt;</span> <span class="n">timeoutHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">PingTimeout</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">PingTimeout</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">trigger</span><span class="o">(</span><span class="k">new</span> <span class="n">Ping</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">self</span><span class="o">),</span> <span class="n">net</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">};</span>
		<span class="o">{</span>
			<span class="n">subscribe</span><span class="o">(</span><span class="n">startHandler</span><span class="o">,</span> <span class="n">control</span><span class="o">);</span>
			<span class="n">subscribe</span><span class="o">(</span><span class="n">pongHandler</span><span class="o">,</span> <span class="n">net</span><span class="o">);</span>
			<span class="n">subscribe</span><span class="o">(</span><span class="n">timeoutHandler</span><span class="o">,</span> <span class="n">timer</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">tearDown</span><span class="o">()</span> <span class="o">{</span>
        	<span class="n">trigger</span><span class="o">(</span><span class="k">new</span> <span class="n">CancelPeriodicTimeout</span><span class="o">(</span><span class="n">timerId</span><span class="o">),</span> <span class="n">timer</span><span class="o">);</span>
        <span class="o">}</span>

		<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PingTimeout</span> <span class="kd">extends</span> <span class="n">Timeout</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="nf">PingTimeout</span><span class="o">(</span><span class="n">SchedulePeriodicTimeout</span> <span class="n">spt</span><span class="o">)</span> <span class="o">{</span>
				<span class="kd">super</span><span class="o">(</span><span class="n">spt</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Init</span> <span class="kd">extends</span> <span class="n">se</span><span class="o">.</span><span class="na">sics</span><span class="o">.</span><span class="na">kompics</span><span class="o">.</span><span class="na">Init</span><span class="o">&lt;</span><span class="n">Pinger</span><span class="o">&gt;</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>
			<span class="kd">public</span> <span class="nf">Init</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">self</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">self</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.ComponentDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Positive</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Network</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ponger</span> <span class="kd">extends</span> <span class="n">ComponentDefinition</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Ponger</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="n">Positive</span><span class="o">&lt;</span><span class="n">Network</span><span class="o">&gt;</span> <span class="n">net</span> <span class="o">=</span> <span class="n">requires</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="kd">private</span> <span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">Ponger</span><span class="o">(</span><span class="n">Init</span> <span class="n">init</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">;</span>
		<span class="o">}</span>

	<span class="n">Handler</span><span class="o">&lt;</span><span class="n">Ping</span><span class="o">&gt;</span> <span class="n">pingHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">Ping</span><span class="o">&gt;(){</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Ping</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">counter</span><span class="o">++;</span>
			<span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Got Ping #{}!&quot;</span><span class="o">,</span> <span class="n">counter</span><span class="o">);</span>
			<span class="n">trigger</span><span class="o">(</span><span class="k">new</span> <span class="n">Pong</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getSource</span><span class="o">()),</span> <span class="n">net</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">};</span>
	<span class="o">{</span>
		<span class="n">subscribe</span><span class="o">(</span><span class="n">pingHandler</span><span class="o">,</span> <span class="n">net</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Init</span> <span class="kd">extends</span> <span class="n">se</span><span class="o">.</span><span class="na">sics</span><span class="o">.</span><span class="na">kompics</span><span class="o">.</span><span class="na">Init</span><span class="o">&lt;</span><span class="n">Ponger</span><span class="o">&gt;</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>
		<span class="kd">public</span> <span class="nf">Init</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">self</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">self</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Finally, we have to create the <code class="docutils literal notranslate"><span class="pre">NettyNetwork</span></code> in the <code class="docutils literal notranslate"><span class="pre">Parent</span></code> class, and connect it appropriately. As a preparation for later, we are going to take the port for <em>self</em> address as a commandline argument in the <code class="docutils literal notranslate"><span class="pre">Main</span></code> class, and hardcode <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> as IP address.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.ComponentDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Init</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.Timer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.java.JavaTimer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Network</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.NettyNetwork</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.NettyInit</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Parent</span> <span class="kd">extends</span> <span class="n">ComponentDefinition</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="nf">Parent</span><span class="o">(</span><span class="n">Init</span> <span class="n">init</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Component</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">JavaTimer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Init</span><span class="o">.</span><span class="na">NONE</span><span class="o">);</span>
		<span class="n">Component</span> <span class="n">network</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">NettyNetwork</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">NettyInit</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">));</span>
		<span class="n">Component</span> <span class="n">pinger</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">Pinger</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">Pinger</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">));</span>
		<span class="n">Component</span> <span class="n">ponger</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">Ponger</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">Ponger</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">));</span>
		<span class="n">Component</span> <span class="n">pinger2</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">Pinger</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">Pinger</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">));</span>


		<span class="n">connect</span><span class="o">(</span><span class="n">pinger</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">timer</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
		<span class="n">connect</span><span class="o">(</span><span class="n">pinger2</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">timer</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>

		<span class="n">connect</span><span class="o">(</span><span class="n">pinger</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">network</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
		<span class="n">connect</span><span class="o">(</span><span class="n">pinger2</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">network</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
		<span class="n">connect</span><span class="o">(</span><span class="n">ponger</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">network</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Init</span> <span class="kd">extends</span> <span class="n">se</span><span class="o">.</span><span class="na">sics</span><span class="o">.</span><span class="na">kompics</span><span class="o">.</span><span class="na">Init</span><span class="o">&lt;</span><span class="n">Parent</span><span class="o">&gt;</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>
		<span class="kd">public</span> <span class="nf">Init</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">self</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">self</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.Kompics</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.UnknownHostException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">InetAddress</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">();</span>
			<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
			<span class="n">TAddress</span> <span class="n">self</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
			<span class="n">Kompics</span><span class="o">.</span><span class="na">createAndStart</span><span class="o">(</span><span class="n">Parent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">Parent</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">self</span><span class="o">),</span> <span class="mi">2</span><span class="o">);</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">Kompics</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
			<span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
			<span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>At this point we can compile and run the code with a slight variation to the usual commands, since we need the port as an argument now (pick a different port if <code class="docutils literal notranslate"><span class="pre">34567</span></code> is in use on your system):</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">mvn</span> <span class="n">clean</span> <span class="n">compile</span>
<span class="n">mvn</span> <span class="n">exec</span><span class="o">:</span><span class="n">java</span> <span class="o">-</span><span class="n">Dexec</span><span class="o">.</span><span class="na">mainClass</span><span class="o">=</span><span class="s">&quot;se.sics.test.Main&quot;</span> <span class="o">-</span><span class="n">Dexec</span><span class="o">.</span><span class="na">args</span><span class="o">=</span><span class="s">&quot;34567&quot;</span>
</pre></div>
</div>
<p>The code until here can be found <a class="reference download internal" download="" href="../../../_downloads/270ce94cfa599a7006bf9259518ef62c/pingpong.zip"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<p>We can see from the output that our setup technically works, but we are back to the problem of getting four <code class="docutils literal notranslate"><span class="pre">Pong</span></code>s on our two <code class="docutils literal notranslate"><span class="pre">Ping</span></code>s. The reason is, of course, that we are cheating. We are running all components in the same JVM, but we are not using proper <a class="reference internal" href="../virtual/virtual.html#virtualnetwork"><span class="std std-ref">Virtual Networks</span></a> support, yet. We also do not actually want to use virtual nodes here, but instead each <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> and <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> should be on a different host (or at least in a different JVM).</p>
<p>Before we can fix this, though, we have to fix another problem that we don’t even see yet: None of our messages are currently serialisable.</p>
</div>
<div class="section" id="serialisation">
<h2>Serialisation<a class="headerlink" href="#serialisation" title="Permalink to this headline">¶</a></h2>
<p>With <code class="docutils literal notranslate"><span class="pre">NettyNetwork</span></code> comes a serialisation framework that builds on Netty’s <a class="reference external" href="http://netty.io/5.0/api/io/netty/buffer/ByteBuf.html" title="io.netty.buffer.ByteBuf"><code class="xref java java-ref docutils literal notranslate"><span class="pre">io.netty.buffer.ByteBuf</span></code></a>. The Kompics part is two-fold, and consists of the <a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/Serializer.html#se.sics.kompics.network.netty.serialization.Serializer" title="se.sics.kompics.network.netty.serialization.Serializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.Serializer</span></code></a> interface, and a <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> registration, mapping, and lookup service in <a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/Serializers.html#se.sics.kompics.network.netty.serialization.Serializers" title="se.sics.kompics.network.netty.serialization.Serializers"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.Serializers</span></code></a>.</p>
<p>For every <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> you write and register you will be required to pick a unique <code class="docutils literal notranslate"><span class="pre">int</span></code> identifier. You are required to keep track of the identifiers you use yourself. Kompics reserves 0-16 for internal use. By default only a single <code class="docutils literal notranslate"><span class="pre">byte</span></code> worth of identifier space is used, to minimise the overhead of the framework. If you are assigning larger identifiers than 255, make sure to use the <code class="docutils literal notranslate"><span class="pre">resize</span></code> method in <code class="docutils literal notranslate"><span class="pre">Serializers</span></code> before registering the respective <code class="docutils literal notranslate"><span class="pre">Serializer</span></code>s.
For larger projects it can become quite difficult to keep track of which identifiers are used and which are free. It is recommended to either assign them all in a single place (e.g., static fields of a class, or a configuration file), or assign subranges to submodules of the project and then do the same single-location-assignment per module.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">toBinary</span></code> and <code class="docutils literal notranslate"><span class="pre">fromBinary</span></code> methods in the <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> interface you are free to do as you like, as long as at the end of the <code class="docutils literal notranslate"><span class="pre">toBinary</span></code> the whole object is in the <code class="docutils literal notranslate"><span class="pre">ByteBuf</span></code> and at the end of the <code class="docutils literal notranslate"><span class="pre">fromBinary</span></code> the same number of bytes that you put into the <code class="docutils literal notranslate"><span class="pre">ByteBuf</span></code> are removed from it again.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Serializers</span></code> class has two important functions. First it registers <code class="docutils literal notranslate"><span class="pre">Serializer</span></code>s into the system so they can be looked up when messages come in that have been serialised with them (as defined by their identifier). And second it maps types to specific <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> instances that are already registered. The most convenient way to do that is by registering a short name to the <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> instance, and then register the class mappings to that name. However, the identifier works as well.</p>
<p>The lookup of <code class="docutils literal notranslate"><span class="pre">Serializer</span></code>s for types is hierarchical, that is, when there is no exact mapping found for the type, the system will traverse its supertype (and interface) hierarchy to find a matching supertype <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> and use that one instead. For example, if the object to be serialised implements Java’s <code class="docutils literal notranslate"><span class="pre">Serializable</span></code> interface and there is no more specific <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> registered, the object will be serialised with Java object serialisation (which is registered by default).</p>
<p>The other default <code class="docutils literal notranslate"><span class="pre">Serializer</span></code>s (and their identifiers) are:</p>
<blockquote>
<div><ol class="arabic simple" start="0">
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/SpecialSerializers-NullSerializer.html#se.sics.kompics.network.netty.serialization.SpecialSerializers.NullSerializer" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.NullSerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.SpecialSerializers.NullSerializer</span></code></a> for <code class="docutils literal notranslate"><span class="pre">null</span></code></li>
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/SpecialSerializers-ByteSerializer.html#se.sics.kompics.network.netty.serialization.SpecialSerializers.ByteSerializer" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.ByteSerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.SpecialSerializers.ByteSerializer</span></code></a> for <code class="docutils literal notranslate"><span class="pre">byte[]</span></code></li>
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/SpecialSerializers-AddressSerializer.html#se.sics.kompics.network.netty.serialization.SpecialSerializers.AddressSerializer" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.AddressSerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.SpecialSerializers.AddressSerializer</span></code></a> for <code class="docutils literal notranslate"><span class="pre">NettyAddress</span></code></li>
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/JavaSerializer.html#se.sics.kompics.network.netty.serialization.JavaSerializer" title="se.sics.kompics.network.netty.serialization.JavaSerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.JavaSerializer</span></code></a> for anything that implements <code class="docutils literal notranslate"><span class="pre">Serializable</span></code></li>
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/ProtobufSerializer.html#se.sics.kompics.network.netty.serialization.ProtobufSerializer" title="se.sics.kompics.network.netty.serialization.ProtobufSerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.ProtobufSerializer</span></code></a> for <a class="reference external" href="https://developers.google.com/protocol-buffers/?hl=en">Protocol Buffers</a> (not registered by default)</li>
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/NettySerializer.html#se.sics.kompics.network.netty.NettySerializer" title="se.sics.kompics.network.netty.NettySerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.NettySerializer</span></code></a> for <code class="docutils literal notranslate"><span class="pre">NettyNetwork</span></code> internal messages</li>
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/SpecialSerializers-UUIDSerializer.html#se.sics.kompics.network.netty.serialization.SpecialSerializers.UUIDSerializer" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.UUIDSerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.SpecialSerializers.UUIDSerializer</span></code></a> for <code class="docutils literal notranslate"><span class="pre">UUID</span></code></li>
<li><a class="reference internal" href="../../../javadoc/component-netty-network/se/sics/kompics/network/netty/serialization/AvroSerializer.html#se.sics.kompics.network.netty.serialization.AvroSerializer" title="se.sics.kompics.network.netty.serialization.AvroSerializer"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.network.netty.serialization.AvroSerializer</span></code></a> for <a class="reference external" href="https://avro.apache.org/">Avro</a> (not registered by default)</li>
<li>to 16. reserved for future additions</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For people familiar with common Java serialisation frameworks it might be obvious that <a class="reference external" href="https://github.com/EsotericSoftware/kryo">Kryo</a> is missing from the above list. This is on purpose. Kompics’ previous messaging middleware used to rely on Kryo for serialisation, but Kryo’s low level object layout hacks lead to a host of problems with deployments that included different types of JVMs (e.g., Oracle JRE and Open JRE, or different versions). For this reason we have purposefully moved away from Kryo serialisation. You are welcome to implement your own Kryo-based <code class="docutils literal notranslate"><span class="pre">Serializer</span></code>, just know that in some setups you might encounter a lot of very difficult to pinpoint bugs.</p>
</div>
<p>In our <em>PingPong</em> example, the classes that need to be serialised are: <code class="docutils literal notranslate"><span class="pre">TAddress</span></code>, <code class="docutils literal notranslate"><span class="pre">THeader</span></code>, <code class="docutils literal notranslate"><span class="pre">Ping</span></code>, and <code class="docutils literal notranslate"><span class="pre">Pong</span></code>. Note that there is no necessesity to serialise <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> separately from <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> at this point, as it has no content of its own. Of course, we could simply have all of those classes implement <code class="docutils literal notranslate"><span class="pre">Serializable</span></code> and be done with it. Since this is a tutorial (and Java’s object serialisation is terribly inefficient) we are instead going to write our own custom serialisers. As preparation for future sections and to show off the system, we will split the serialisation logic into two classes: <code class="docutils literal notranslate"><span class="pre">NetSerializer</span></code> will deal with <code class="docutils literal notranslate"><span class="pre">TAddress</span></code> and <code class="docutils literal notranslate"><span class="pre">THeader</span></code> instances, while <code class="docutils literal notranslate"><span class="pre">PingPongSerializer</span></code> will deal with <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> messages. Since <code class="docutils literal notranslate"><span class="pre">THeader</span></code> is part of the messages, we will of course call the <code class="docutils literal notranslate"><span class="pre">NetSerializer</span></code> from the <code class="docutils literal notranslate"><span class="pre">PingPongSerializer</span></code>, but we will act as if we don’t know what kind of <code class="docutils literal notranslate"><span class="pre">Header</span></code> we are dealing with and let the serialisation framework figure that out. Similarly, <code class="docutils literal notranslate"><span class="pre">TAddress</span></code>es are part of a <code class="docutils literal notranslate"><span class="pre">THeader</span></code> so we will invoke the <code class="docutils literal notranslate"><span class="pre">NetSerializer</span></code> from itself. Note, that the difference between two approaches is, whether or not the identifier will be prepended. If we invoke a <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> manually from within another <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> it is assumed that it will be known at serialisation and deserialisation time what the object is and the identifier can be omitted. Otherwise the system will figure it out itself using the identifier.</p>
<p>In order to keep our identifier spaces separate we’ll pick 100 for the <code class="docutils literal notranslate"><span class="pre">NetSerializer</span></code> and 200 for the <code class="docutils literal notranslate"><span class="pre">PingPongSerializer</span></code>. And since we only have two instances to deal with, we’ll just define the identifiers within the classes in the lazy way.
We also added some extra constructors to the messages, to make it easier to use <code class="docutils literal notranslate"><span class="pre">THeader</span></code> instances from another <code class="docutils literal notranslate"><span class="pre">Serializer</span></code> during deserialisation.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.base.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.UnknownHostException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.serialization.Serializer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NetSerializer</span> <span class="kd">implements</span> <span class="n">Serializer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">ADDR</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">HEADER</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">identifier</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toBinary</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">TAddress</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">(</span><span class="n">TAddress</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">ADDR</span><span class="o">);</span> <span class="c1">// mark which type we are serialising (1 byte)</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">addr</span><span class="o">.</span><span class="na">getIp</span><span class="o">().</span><span class="na">getAddress</span><span class="o">());</span> <span class="c1">// 4 bytes IP (let&#39;s hope it&#39;s IPv4^^)</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">addr</span><span class="o">.</span><span class="na">getPort</span><span class="o">());</span> <span class="c1">// we only need 2 bytes here</span>
            <span class="c1">// total 7 bytes</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">THeader</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">THeader</span> <span class="n">header</span> <span class="o">=</span> <span class="o">(</span><span class="n">THeader</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">HEADER</span><span class="o">);</span> <span class="c1">// mark which type we are serialising (1 byte)</span>
            <span class="k">this</span><span class="o">.</span><span class="na">toBinary</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">src</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// use this serialiser again (7 bytes)</span>
            <span class="k">this</span><span class="o">.</span><span class="na">toBinary</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">dst</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// use this serialiser again (7 bytes)</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">proto</span><span class="o">.</span><span class="na">ordinal</span><span class="o">());</span> <span class="c1">// 1 byte is enough</span>
            <span class="c1">// total 16 bytes</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">fromBinary</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">hint</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span> <span class="n">type</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// read the first byte to figure out the type</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">ADDR</span><span class="o">:</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">ipBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
                <span class="n">buf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">ipBytes</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">InetAddress</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByAddress</span><span class="o">(</span><span class="n">ipBytes</span><span class="o">);</span> <span class="c1">// 4 bytes</span>
                    <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readUnsignedShort</span><span class="o">();</span> <span class="c1">// 2 bytes</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span> <span class="c1">// total of 7, check</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="c1">// let Netty deal with this</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">HEADER</span><span class="o">:</span> <span class="o">{</span>
                <span class="n">TAddress</span> <span class="n">src</span> <span class="o">=</span> <span class="o">(</span><span class="n">TAddress</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">fromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">absent</span><span class="o">());</span> <span class="c1">// We already know what it&#39;s going to be (7 bytes)</span>
                <span class="n">TAddress</span> <span class="n">dst</span> <span class="o">=</span> <span class="o">(</span><span class="n">TAddress</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">fromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">absent</span><span class="o">());</span> <span class="c1">// same here (7 bytes)</span>
                <span class="kt">int</span> <span class="n">protoOrd</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// 1 byte</span>
                <span class="n">Transport</span> <span class="n">proto</span> <span class="o">=</span> <span class="n">Transport</span><span class="o">.</span><span class="na">values</span><span class="o">()[</span><span class="n">protoOrd</span><span class="o">];</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">THeader</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">dst</span><span class="o">,</span> <span class="n">proto</span><span class="o">);</span> <span class="c1">// total of 16 bytes, check</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// strange things happened^^</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.base.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.serialization.Serializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.serialization.Serializers</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PingPongSerializer</span> <span class="kd">implements</span> <span class="n">Serializer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">PING</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">PONG</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">identifier</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">200</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toBinary</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Ping</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Ping</span> <span class="n">ping</span> <span class="o">=</span> <span class="o">(</span><span class="n">Ping</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">PING</span><span class="o">);</span> <span class="c1">// 1 byte</span>
            <span class="n">Serializers</span><span class="o">.</span><span class="na">toBinary</span><span class="o">(</span><span class="n">ping</span><span class="o">.</span><span class="na">header</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// 1 byte serialiser id + 16 bytes THeader</span>
            <span class="c1">// total 18 bytes</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Pong</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Pong</span> <span class="n">pong</span> <span class="o">=</span> <span class="o">(</span><span class="n">Pong</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">PONG</span><span class="o">);</span> <span class="c1">// 1 byte</span>
            <span class="n">Serializers</span><span class="o">.</span><span class="na">toBinary</span><span class="o">(</span><span class="n">pong</span><span class="o">.</span><span class="na">header</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// 1 byte serialiser id + 16 bytes THeader</span>
            <span class="c1">// total 18 bytes</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">fromBinary</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">hint</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span> <span class="n">type</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// 1 byte</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">PING</span><span class="o">:</span> <span class="o">{</span>
                <span class="n">THeader</span> <span class="n">header</span> <span class="o">=</span> <span class="o">(</span><span class="n">THeader</span><span class="o">)</span> <span class="n">Serializers</span><span class="o">.</span><span class="na">fromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">absent</span><span class="o">());</span> <span class="c1">// 1 byte serialiser id + 16 bytes THeader</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Ping</span><span class="o">(</span><span class="n">header</span><span class="o">);</span> <span class="c1">// 18 bytes total, check</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">PONG</span><span class="o">:</span> <span class="o">{</span>
                <span class="n">THeader</span> <span class="n">header</span> <span class="o">=</span> <span class="o">(</span><span class="n">THeader</span><span class="o">)</span> <span class="n">Serializers</span><span class="o">.</span><span class="na">fromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">absent</span><span class="o">());</span> <span class="c1">// 1 byte serialiser id + 16 bytes THeader</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Pong</span><span class="o">(</span><span class="n">header</span><span class="o">);</span> <span class="c1">// 18 bytes total, check</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The serialisation above code is not particularly space efficient, since that was not the purpose. To get an idea how to use bit-fields to get a significant space reduction on these kind of frequently used serialisation procedures, take a look at the source code of the <code class="docutils literal notranslate"><span class="pre">SpecialSerializers</span></code> class over on <a class="reference external" href="https://github.com/kompics/kompics/blob/master/basic/component-netty-network/src/main/java/se/sics/kompics/network/netty/serialization/SpecialSerializers.java">Github</a>.</p>
</div>
<p>All that is left is now is to register the new <code class="docutils literal notranslate"><span class="pre">Serializer</span></code>s and map the right types to them. We add the following to the <code class="docutils literal notranslate"><span class="pre">Main</span></code> class:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">static</span> <span class="o">{</span>
        <span class="c1">// register</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">NetSerializer</span><span class="o">(),</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">PingPongSerializer</span><span class="o">(),</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
        <span class="c1">// map</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">TAddress</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">THeader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">Ping</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">Pong</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="distributed-pingpong">
<span id="distributedpingpong"></span><h2>Distributed PingPong<a class="headerlink" href="#distributed-pingpong" title="Permalink to this headline">¶</a></h2>
<p>Now we are prepared for a true distributed deployment of our <em>PingPong</em> example. There are a number of changes we need to make to the way we set up the component hierarchy. First of all, we want to deploy <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> and <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> separately, and they also need different parameters. The <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> is purely reactive and it only needs to know its own <em>self</em> address. The <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> on the other hand needs to know both its own address and a <code class="docutils literal notranslate"><span class="pre">Ponger</span></code>’s. We are going to make use of that distinction in the <code class="docutils literal notranslate"><span class="pre">Main</span></code> class to decide which one to start. If we see two commandline arguments (1 IP and 1 port), we are going to start a <code class="docutils literal notranslate"><span class="pre">Ponger</span></code>. If, however, we see four commandline arguments (2 IPs and 2 ports), we are going to start a <code class="docutils literal notranslate"><span class="pre">Pinger</span></code>. Since our application classes now need different setup, we are also going to split the <code class="docutils literal notranslate"><span class="pre">Parent</span></code> into a <code class="docutils literal notranslate"><span class="pre">PingerParent</span></code> and a <code class="docutils literal notranslate"><span class="pre">PongerParent</span></code>. Note that it is always a good idea to have a class without any business logic that sets up the <code class="docutils literal notranslate"><span class="pre">Network</span></code> and <code class="docutils literal notranslate"><span class="pre">Timer</span></code> connections, as you will see in the section on <a class="reference internal" href="../../simulation/index.html#simulation"><span class="std std-ref">Simulation</span></a>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.ComponentDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Network</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.NettyInit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.NettyNetwork</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.Timer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.java.JavaTimer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PingerParent</span> <span class="kd">extends</span> <span class="n">ComponentDefinition</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">PingerParent</span><span class="o">(</span><span class="n">Init</span> <span class="n">init</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Component</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">JavaTimer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Init</span><span class="o">.</span><span class="na">NONE</span><span class="o">);</span>
        <span class="n">Component</span> <span class="n">network</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">NettyNetwork</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">NettyInit</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">));</span>
        <span class="n">Component</span> <span class="n">pinger</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">Pinger</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">Pinger</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">,</span> <span class="n">init</span><span class="o">.</span><span class="na">ponger</span><span class="o">));</span>

        <span class="n">connect</span><span class="o">(</span><span class="n">pinger</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">timer</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">Channel</span><span class="o">.</span><span class="na">TWO_WAY</span><span class="o">);</span>

        <span class="n">connect</span><span class="o">(</span><span class="n">pinger</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">network</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">Channel</span><span class="o">.</span><span class="na">TWO_WAY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Init</span> <span class="kd">extends</span> <span class="n">se</span><span class="o">.</span><span class="na">sics</span><span class="o">.</span><span class="na">kompics</span><span class="o">.</span><span class="na">Init</span><span class="o">&lt;</span><span class="n">PingerParent</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">ponger</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Init</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">self</span><span class="o">,</span> <span class="n">TAddress</span> <span class="n">ponger</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">self</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">ponger</span> <span class="o">=</span> <span class="n">ponger</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.ComponentDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Network</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.NettyInit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.NettyNetwork</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PongerParent</span> <span class="kd">extends</span> <span class="n">ComponentDefinition</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">PongerParent</span><span class="o">(</span><span class="n">Init</span> <span class="n">init</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Component</span> <span class="n">network</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">NettyNetwork</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">NettyInit</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">));</span>
        <span class="n">Component</span> <span class="n">ponger</span> <span class="o">=</span> <span class="n">create</span><span class="o">(</span><span class="n">Ponger</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">Ponger</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">init</span><span class="o">.</span><span class="na">self</span><span class="o">));</span>

        <span class="n">connect</span><span class="o">(</span><span class="n">ponger</span><span class="o">.</span><span class="na">getNegative</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">network</span><span class="o">.</span><span class="na">getPositive</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">Channel</span><span class="o">.</span><span class="na">TWO_WAY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Init</span> <span class="kd">extends</span> <span class="n">se</span><span class="o">.</span><span class="na">sics</span><span class="o">.</span><span class="na">kompics</span><span class="o">.</span><span class="na">Init</span><span class="o">&lt;</span><span class="n">PongerParent</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Init</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">self</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">self</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.UnknownHostException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Kompics</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.serialization.Serializers</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    
    <span class="kd">static</span> <span class="o">{</span>
        <span class="c1">// register</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">NetSerializer</span><span class="o">(),</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">PingPongSerializer</span><span class="o">(),</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
        <span class="c1">// map</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">TAddress</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">THeader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">Ping</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
        <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">Pong</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// start Ponger</span>
                <span class="n">InetAddress</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
                <span class="n">TAddress</span> <span class="n">self</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
                <span class="n">Kompics</span><span class="o">.</span><span class="na">createAndStart</span><span class="o">(</span><span class="n">PongerParent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">PongerParent</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">self</span><span class="o">),</span> <span class="mi">2</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Starting Ponger at &quot;</span> <span class="o">+</span> <span class="n">self</span><span class="o">);</span>
                <span class="c1">// no shutdown this time...act like a server and keep running until externally exited</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// start Pinger</span>
                <span class="n">InetAddress</span> <span class="n">myIp</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                <span class="kt">int</span> <span class="n">myPort</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
                <span class="n">TAddress</span> <span class="n">self</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">myIp</span><span class="o">,</span> <span class="n">myPort</span><span class="o">);</span>
                <span class="n">InetAddress</span> <span class="n">pongerIp</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>
                <span class="kt">int</span> <span class="n">pongerPort</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">3</span><span class="o">]);</span>
                <span class="n">TAddress</span> <span class="n">ponger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">pongerIp</span><span class="o">,</span> <span class="n">pongerPort</span><span class="o">);</span>
                <span class="n">Kompics</span><span class="o">.</span><span class="na">createAndStart</span><span class="o">(</span><span class="n">PingerParent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">PingerParent</span><span class="o">.</span><span class="na">Init</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">ponger</span><span class="o">),</span> <span class="mi">2</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Starting Pinger at&quot;</span> <span class="o">+</span> <span class="n">self</span> <span class="o">+</span> <span class="s">&quot; to &quot;</span> <span class="o">+</span> <span class="n">ponger</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">Kompics</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
                <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Invalid number of parameters (2 for Ponger, 4 for Pinger)&quot;</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now we are finally ready to try this. Use the usual command to compile the code:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">mvn</span> <span class="n">clean</span> <span class="n">compile</span>
</pre></div>
</div>
<p>Now the following commands should be run in different terminals, preferably side by side so you can clearly see how things are happening. For all the examples feel free to change the IPs and ports as you like, but be sure they match up correctly.</p>
<p>Start the <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> first with:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">mvn</span> <span class="n">exec</span><span class="o">:</span><span class="n">java</span> <span class="o">-</span><span class="n">Dexec</span><span class="o">.</span><span class="na">mainClass</span><span class="o">=</span><span class="s">&quot;se.sics.test.Main&quot;</span> <span class="o">-</span><span class="n">Dexec</span><span class="o">.</span><span class="na">args</span><span class="o">=</span><span class="s">&quot;127.0.0.1 34567&quot;</span>
</pre></div>
</div>
<p>Then start a <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> with:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">mvn</span> <span class="n">exec</span><span class="o">:</span><span class="n">java</span> <span class="o">-</span><span class="n">Dexec</span><span class="o">.</span><span class="na">mainClass</span><span class="o">=</span><span class="s">&quot;se.sics.test.Main&quot;</span> <span class="o">-</span><span class="n">Dexec</span><span class="o">.</span><span class="na">args</span><span class="o">=</span><span class="s">&quot;127.0.0.1 45678 127.0.0.1 34567&quot;</span>
</pre></div>
</div>
<p>You can start the same <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> multiple times or start as many <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> JVM in parallel as you like. Make sure they all have their own port, though!
You will see that there is no <code class="docutils literal notranslate"><span class="pre">Ping</span></code> amplification anymore as we saw in the last example. All messages are now correctly addressed and replied to. If you can’t clearly see what’s going on among all the logging output try to reduce the logging level to <code class="docutils literal notranslate"><span class="pre">INFO</span></code> in the <code class="file docutils literal notranslate"><span class="pre">log4j.properties</span></code>. Finally, use <kbd class="kbd docutils literal notranslate">Control-c</kbd> to shutdown the <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> as it will run forever otherwise.</p>
<p>As always the code until here can be downloaded <a class="reference download internal" download="" href="../../../_downloads/8db1bf30090be088f4f3828e7bceb65f/pingpong-distributed.zip"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
</div>
<div class="section" id="cleanup-config-files-classmatchers-and-assembly">
<span id="netcleanup"></span><h2>Cleanup: Config files, ClassMatchers, and Assembly<a class="headerlink" href="#cleanup-config-files-classmatchers-and-assembly" title="Permalink to this headline">¶</a></h2>
<p>While our example from the previous section works, there are still a number of things that are not optimal with it. We’ll use this section to make the whole code a bit nicer, and also change the way we deploy, since we can’t really rely on Maven being present on all target machines.</p>
<div class="section" id="configuration-files">
<h3>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h3>
<p>First of all, you might have noticed that we have a lot of redundancy in the passing around of parameters between the different component <code class="docutils literal notranslate"><span class="pre">Init</span></code> objects. Furthermore, our reading from the commandline is not the safest. Sure, there are good libraries for commandline options, but this is not really what we want. What we want is to define a bunch of values once and then be able to access them from anywhere within the code. The right solution for this problem is using a configuration file, where we write IPs and ports and such things, and a configuration library that knows how to give us access to the values in our code. Kompics has its own configuration library, which by default uses <a class="reference external" href="https://github.com/typesafehub/config">Typesafe Config</a> as a backend.</p>
<p>If you prefer a different configuration library, you may of course wrap it in an implementation of <a class="reference internal" href="../../../javadoc/core/se/sics/kompics/config/BaselineConfig.html#se.sics.kompics.config.BaselineConfig" title="se.sics.kompics.config.BaselineConfig"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.config.BaselineConfig</span></code></a> and pass it into <a class="reference internal" href="../../../javadoc/core/se/sics/kompics/config/Config-Factory.html#se.sics.kompics.config.Config.Factory" title="se.sics.kompics.config.Config.Factory"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.config.Config.Factory</span></code></a> and then replace the default config with your custom one in <code class="docutils literal notranslate"><span class="pre">Kompics.setConfig</span></code> before starting the runtime.</p>
<p>For the tutorial we are going to stick to Typesafe Config as a baseline. We are thus going to add a <code class="file docutils literal notranslate"><span class="pre">src/main/resources/reference.conf</span></code> file, where we describe default values for all our config options. This is not strictly speaking necessary, but it is generally a good idea to have one place your users can look at where all possible config values are outlined. While we are at it, we also make the timeout period configurable.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">reference.conf</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span>pingpong {
	self {
		host = &quot;127.0.0.1&quot;
		port = 34567
	}
	pinger {
		timeout = 1000
		pongeraddr {
			host = &quot;127.0.0.1&quot;
			port = 45678
		}
	}
}
</pre></div>
</div>
</div>
<p>Now that we have a configuration file, we can simply throw away all the <code class="docutils literal notranslate"><span class="pre">Init</span></code> classes we created before, and pull out the desired values from the config in the <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> and <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> constructors.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Pinger.java</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="nf">Pinger</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">InetAddress</span> <span class="n">selfIp</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.self.host&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="kt">int</span> <span class="n">selfPort</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.self.port&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">selfIp</span><span class="o">,</span> <span class="n">selfPort</span><span class="o">);</span>
        <span class="n">InetAddress</span> <span class="n">pongerIp</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.pinger.pongeraddr.host&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="kt">int</span> <span class="n">pongerPort</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.pinger.pongeraddr.port&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ponger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">pongerIp</span><span class="o">,</span> <span class="n">pongerPort</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">Handler</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span> <span class="n">startHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Start</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">period</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.pinger.timeout&quot;</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">SchedulePeriodicTimeout</span> <span class="n">spt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SchedulePeriodicTimeout</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">period</span><span class="o">);</span>
        <span class="n">PingTimeout</span> <span class="n">timeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PingTimeout</span><span class="o">(</span><span class="n">spt</span><span class="o">);</span>
        <span class="n">spt</span><span class="o">.</span><span class="na">setTimeoutEvent</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
        <span class="n">trigger</span><span class="o">(</span><span class="n">spt</span><span class="o">,</span> <span class="n">timer</span><span class="o">);</span>
        <span class="n">timerId</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">.</span><span class="na">getTimeoutId</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Ponger.java</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="nf">Ponger</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">InetAddress</span> <span class="n">selfIp</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.self.host&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="kt">int</span> <span class="n">selfPort</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.self.port&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">selfIp</span><span class="o">,</span> <span class="n">selfPort</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>However, since the <code class="docutils literal notranslate"><span class="pre">NettyNetwork</span></code> needs to know the <em>self</em> address as well, we are going to have to duplicate some of this work in the <code class="docutils literal notranslate"><span class="pre">PingerParent</span></code> and <code class="docutils literal notranslate"><span class="pre">PongerParent</span></code>. Alternatively we could continue to pass in the <em>self</em> address via the <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> and <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> <code class="docutils literal notranslate"><span class="pre">Init</span></code> classes and only construct it once in the respective parent class.</p>
<p>There is another solution, though, that gives a lot more concise code. Kompics’ configuration system supports so called <em>conversions</em>, which are used to convert compatible types from the config values to the requested values. For example, it would be unnecessary to throw an exception when the user is asking for an instance of <code class="docutils literal notranslate"><span class="pre">Long</span></code> but the value is returned as <code class="docutils literal notranslate"><span class="pre">Integer</span></code> by Typesafe Config. Instead the config library will look through a number of <a class="reference internal" href="../../../javadoc/core/se/sics/kompics/config/Converter.html#se.sics.kompics.config.Converter" title="se.sics.kompics.config.Converter"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.config.Converter</span></code></a> instances that are registered at <a class="reference internal" href="../../../javadoc/core/se/sics/kompics/config/Conversions.html#se.sics.kompics.config.Conversions" title="se.sics.kompics.config.Conversions"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.config.Conversions</span></code></a> (this is very similar to how the serialisation framework is used) and try to find one that can convert an <code class="docutils literal notranslate"><span class="pre">Integer</span></code> object to a <code class="docutils literal notranslate"><span class="pre">Long</span></code> object. Thus we can use this system to write <code class="docutils literal notranslate"><span class="pre">Converter</span></code> that takes the object at <code class="docutils literal notranslate"><span class="pre">&quot;pingpong.self&quot;</span></code> for example and converts it to a <code class="docutils literal notranslate"><span class="pre">TAddress</span></code>. It turns out that the way we wrote the <code class="file docutils literal notranslate"><span class="pre">reference.conf</span></code> Typesafe Config will give us a <code class="docutils literal notranslate"><span class="pre">Map</span></code> with the subvalues as keys. In this case we can pull out the values, <em>convert</em> them to <code class="docutils literal notranslate"><span class="pre">String</span></code> and <code class="docutils literal notranslate"><span class="pre">Integer</span></code> instances respectively and then construct the <code class="docutils literal notranslate"><span class="pre">TAddress</span></code> as before. As an example, we are also going to support an alternative way to write a <code class="docutils literal notranslate"><span class="pre">TAddress</span></code>, which is a single <code class="docutils literal notranslate"><span class="pre">String</span></code> in the following format: <code class="docutils literal notranslate"><span class="pre">&quot;127.0.0.1:34567&quot;</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">TAddressConverter.java</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.UnknownHostException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.config.Conversions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.config.Converter</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TAddressConverter</span> <span class="kd">implements</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">TAddress</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TAddress</span> <span class="nf">convert</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Map</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Map</span> <span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
                <span class="n">String</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">Conversions</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;host&quot;</span><span class="o">),</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">Conversions</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;port&quot;</span><span class="o">),</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">InetAddress</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">hostname</span><span class="o">);</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">ipport</span> <span class="o">=</span> <span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">o</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">);</span>
                <span class="n">InetAddress</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="n">ipport</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">ipport</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">TAddress</span><span class="o">&gt;</span> <span class="nf">type</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">TAddress</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Additionally we also need to register the new <code class="docutils literal notranslate"><span class="pre">Converter</span></code> in the static initialisation block of the <code class="docutils literal notranslate"><span class="pre">Main</span></code> class and then we can get a <code class="docutils literal notranslate"><span class="pre">TAddress</span></code> by simply calling <code class="docutils literal notranslate"><span class="pre">config().getValue(&quot;pingpong.self&quot;,</span> <span class="pre">TAddress.class);</span></code>, for example.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">Main.java</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">static</span> <span class="o">{</span>
    <span class="c1">// register</span>
    <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">NetSerializer</span><span class="o">(),</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
    <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">PingPongSerializer</span><span class="o">(),</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
    <span class="c1">// map</span>
    <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">TAddress</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
    <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">THeader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;netS&quot;</span><span class="o">);</span>
    <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">Ping</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
    <span class="n">Serializers</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">Pong</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;ppS&quot;</span><span class="o">);</span>
    <span class="c1">// conversions</span>
    <span class="n">Conversions</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">new</span> <span class="n">TAddressConverter</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We are still doing the same work as before, technically even more since we have to look through all the <code class="docutils literal notranslate"><span class="pre">Converter</span></code> instances now. It simply looks a lot nicer like this, as there is less unnecessary code duplication. At this time none of the converted values are cached anywhere, thus it is recommended to always write values from the configuration, that are often used, into local fields, instead of pulling them out of the config on demand every time they are needed.</p>
</div>
</div>
<div class="section" id="message-matching-handlers">
<span id="id1"></span><h3>Message Matching Handlers<a class="headerlink" href="#message-matching-handlers" title="Permalink to this headline">¶</a></h3>
<p>Another thing that feels awkward with our code is how we write network messages. Our <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> class does almost nothing except define what kind of header we expect, and all actual network messages like <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> have to implement all these annoying constructors that <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> requires instead of focusing on their business logic (which is trivially simple to non-existent^^). We would much rather have the <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> act as a kind of container for <em>data</em> and then <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> would simply be payloads. But then how would the handlers of <code class="docutils literal notranslate"><span class="pre">Pinger</span></code> and <code class="docutils literal notranslate"><span class="pre">Ponger</span></code> know which messages are for them, i.e. are <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> respectively, and which are for other classes. They would have to match on <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> and handle all network messages. That would be way too expensive in a large system. Under no circumstance do we want to schedule components unnecessarily. The solution to our problem can be found in <a class="reference internal" href="../../../javadoc/core/se/sics/kompics/ClassMatchedHandler.html#se.sics.kompics.ClassMatchedHandler" title="se.sics.kompics.ClassMatchedHandler"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.ClassMatchedHandler</span></code></a> which provides a very simple form of <em>pattern matching</em> for Kompics. Instead of matching on a single event type, it matches on two event types: The <em>context</em> type, which we will define as <code class="docutils literal notranslate"><span class="pre">TMessage</span></code>, and the <em>content</em> type which will be <code class="docutils literal notranslate"><span class="pre">Ping</span></code> and <code class="docutils literal notranslate"><span class="pre">Pong</span></code> respectively.</p>
<p>We shall rewrite <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> to carry any kind of <code class="docutils literal notranslate"><span class="pre">KompicsEvent</span></code> as a payload, and to act as <a class="reference internal" href="../../../javadoc/core/se/sics/kompics/PatternExtractor.html#se.sics.kompics.PatternExtractor" title="se.sics.kompics.PatternExtractor"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.PatternExtractor</span></code></a> for the payload. We’ll also move its serialisation logic into the <code class="docutils literal notranslate"><span class="pre">NetSerializer</span></code> leaving the <code class="docutils literal notranslate"><span class="pre">PingPongSerializer</span></code> rather trivial as a result.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.KompicsEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.PatternExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Msg</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TMessage</span> <span class="kd">implements</span> <span class="n">Msg</span><span class="o">&lt;</span><span class="n">TAddress</span><span class="o">,</span> <span class="n">THeader</span><span class="o">&gt;,</span> <span class="n">PatternExtractor</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;,</span> <span class="n">KompicsEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">THeader</span> <span class="n">header</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">KompicsEvent</span> <span class="n">payload</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TMessage</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">src</span><span class="o">,</span> <span class="n">TAddress</span> <span class="n">dst</span><span class="o">,</span> <span class="n">Transport</span> <span class="n">protocol</span><span class="o">,</span> <span class="n">KompicsEvent</span> <span class="n">payload</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">header</span> <span class="o">=</span> <span class="k">new</span> <span class="n">THeader</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">dst</span><span class="o">,</span> <span class="n">protocol</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">TMessage</span><span class="o">(</span><span class="n">THeader</span> <span class="n">header</span><span class="o">,</span> <span class="n">KompicsEvent</span> <span class="n">payload</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">THeader</span> <span class="nf">getHeader</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TAddress</span> <span class="nf">getSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">.</span><span class="na">src</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">TAddress</span> <span class="nf">getDestination</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">.</span><span class="na">dst</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Transport</span> <span class="nf">getProtocol</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">header</span><span class="o">.</span><span class="na">proto</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">extractPattern</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">KompicsEvent</span> <span class="nf">extractValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">payload</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.KompicsEvent</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ping</span> <span class="kd">implements</span> <span class="n">KompicsEvent</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">se.sics.kompics.KompicsEvent</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pong</span> <span class="kd">implements</span> <span class="n">KompicsEvent</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.base.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.UnknownHostException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.KompicsEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.serialization.Serializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.serialization.Serializers</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NetSerializer</span> <span class="kd">implements</span> <span class="n">Serializer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">ADDR</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">HEADER</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">MSG</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">identifier</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toBinary</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">TAddress</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TAddress</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">(</span><span class="n">TAddress</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">ADDR</span><span class="o">);</span> <span class="c1">// mark which type we are serialising (1 byte)</span>
            <span class="n">addressToBinary</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// 6 bytes</span>
            <span class="c1">// total 7 bytes</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">THeader</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">THeader</span> <span class="n">header</span> <span class="o">=</span> <span class="o">(</span><span class="n">THeader</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">HEADER</span><span class="o">);</span> <span class="c1">// mark which type we are serialising (1 byte)</span>
            <span class="n">headerToBinary</span><span class="o">(</span><span class="n">header</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// 13 bytes</span>
            <span class="c1">// total 14 bytes</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">TMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TMessage</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">MSG</span><span class="o">);</span> <span class="c1">// mark which type we are serialising (1 byte)</span>
            <span class="n">headerToBinary</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">header</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// 13 bytes</span>
            <span class="n">Serializers</span><span class="o">.</span><span class="na">toBinary</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// no idea what it is, let the framework deal with it</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">fromBinary</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">hint</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span> <span class="n">type</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// read the first byte to figure out the type</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">ADDR</span><span class="o">:</span>
                <span class="k">return</span> <span class="n">addressFromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
            <span class="k">case</span> <span class="n">HEADER</span><span class="o">:</span>
                <span class="k">return</span> <span class="n">headerFromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
            <span class="k">case</span> <span class="n">MSG</span><span class="o">:</span> <span class="o">{</span>
                <span class="n">THeader</span> <span class="n">header</span> <span class="o">=</span> <span class="n">headerFromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span> <span class="c1">// 13 bytes</span>
                <span class="n">KompicsEvent</span> <span class="n">payload</span> <span class="o">=</span> <span class="o">(</span><span class="n">KompicsEvent</span><span class="o">)</span> <span class="n">Serializers</span><span class="o">.</span><span class="na">fromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">absent</span><span class="o">());</span> <span class="c1">// don&#39;t know what it is but KompicsEvent is the upper bound</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">TMessage</span><span class="o">(</span><span class="n">header</span><span class="o">,</span> <span class="n">payload</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// strange things happened^^</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">headerToBinary</span><span class="o">(</span><span class="n">THeader</span> <span class="n">header</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addressToBinary</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">src</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// 6 bytes</span>
        <span class="n">addressToBinary</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">dst</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span> <span class="c1">// 6 bytes</span>
        <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">proto</span><span class="o">.</span><span class="na">ordinal</span><span class="o">());</span> <span class="c1">// 1 byte is enough</span>
        <span class="c1">// total of 13 bytes</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">THeader</span> <span class="nf">headerFromBinary</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">TAddress</span> <span class="n">src</span> <span class="o">=</span> <span class="n">addressFromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span> <span class="c1">// 6 bytes</span>
        <span class="n">TAddress</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">addressFromBinary</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span> <span class="c1">// 6 bytes</span>
        <span class="kt">int</span> <span class="n">protoOrd</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// 1 byte</span>
        <span class="n">Transport</span> <span class="n">proto</span> <span class="o">=</span> <span class="n">Transport</span><span class="o">.</span><span class="na">values</span><span class="o">()[</span><span class="n">protoOrd</span><span class="o">];</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">THeader</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">dst</span><span class="o">,</span> <span class="n">proto</span><span class="o">);</span> <span class="c1">// total of 13 bytes, check</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addressToBinary</span><span class="o">(</span><span class="n">TAddress</span> <span class="n">addr</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">buf</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">addr</span><span class="o">.</span><span class="na">getIp</span><span class="o">().</span><span class="na">getAddress</span><span class="o">());</span> <span class="c1">// 4 bytes IP (let&#39;s hope it&#39;s IPv4^^)</span>
        <span class="n">buf</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="n">addr</span><span class="o">.</span><span class="na">getPort</span><span class="o">());</span> <span class="c1">// we only need 2 bytes here</span>
        <span class="c1">// total of 6 bytes</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">TAddress</span> <span class="nf">addressFromBinary</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">ipBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
        <span class="n">buf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">ipBytes</span><span class="o">);</span> <span class="c1">// 4 bytes</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">InetAddress</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByAddress</span><span class="o">(</span><span class="n">ipBytes</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readUnsignedShort</span><span class="o">();</span> <span class="c1">// 2 bytes</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">TAddress</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span> <span class="c1">// total of 6, check</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="c1">// let Netty deal with this</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.base.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.netty.serialization.Serializer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PingPongSerializer</span> <span class="kd">implements</span> <span class="n">Serializer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">PING</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span> <span class="n">PONG</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">identifier</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">200</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toBinary</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Ping</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Ping</span> <span class="n">ping</span> <span class="o">=</span> <span class="o">(</span><span class="n">Ping</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">PING</span><span class="o">);</span> <span class="c1">// 1 byte</span>
            <span class="c1">// total 1 bytes</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Pong</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Pong</span> <span class="n">pong</span> <span class="o">=</span> <span class="o">(</span><span class="n">Pong</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">PONG</span><span class="o">);</span> <span class="c1">// 1 byte</span>
            <span class="c1">// total 1 bytes</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">fromBinary</span><span class="o">(</span><span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">hint</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span> <span class="n">type</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span> <span class="c1">// 1 byte</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">PING</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Ping</span><span class="o">();</span> <span class="c1">// 1 bytes total, check</span>
            <span class="k">case</span> <span class="n">PONG</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Pong</span><span class="o">();</span> <span class="c1">// 1 bytes total, check</span>

        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.ClassMatchedHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.ComponentDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Handler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Positive</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Start</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Network</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.CancelPeriodicTimeout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.SchedulePeriodicTimeout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.Timeout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.timer.Timer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pinger</span> <span class="kd">extends</span> <span class="n">ComponentDefinition</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Pinger</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">Positive</span><span class="o">&lt;</span><span class="n">Network</span><span class="o">&gt;</span> <span class="n">net</span> <span class="o">=</span> <span class="n">requires</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">Positive</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">&gt;</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">requires</span><span class="o">(</span><span class="n">Timer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">UUID</span> <span class="n">timerId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">ponger</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Pinger</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.self&quot;</span><span class="o">,</span> <span class="n">TAddress</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ponger</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.pinger.pongeraddr&quot;</span><span class="o">,</span> <span class="n">TAddress</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">Handler</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;</span> <span class="n">startHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">Start</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Start</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">period</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.pinger.timeout&quot;</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">SchedulePeriodicTimeout</span> <span class="n">spt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SchedulePeriodicTimeout</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">period</span><span class="o">);</span>
            <span class="n">PingTimeout</span> <span class="n">timeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PingTimeout</span><span class="o">(</span><span class="n">spt</span><span class="o">);</span>
            <span class="n">spt</span><span class="o">.</span><span class="na">setTimeoutEvent</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
            <span class="n">trigger</span><span class="o">(</span><span class="n">spt</span><span class="o">,</span> <span class="n">timer</span><span class="o">);</span>
            <span class="n">timerId</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">.</span><span class="na">getTimeoutId</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="n">ClassMatchedHandler</span><span class="o">&lt;</span><span class="n">Pong</span><span class="o">,</span> <span class="n">TMessage</span><span class="o">&gt;</span> <span class="n">pongHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassMatchedHandler</span><span class="o">&lt;</span><span class="n">Pong</span><span class="o">,</span> <span class="n">TMessage</span><span class="o">&gt;()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Pong</span> <span class="n">content</span><span class="o">,</span> <span class="n">TMessage</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">counter</span><span class="o">++;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Got Pong #{}!&quot;</span><span class="o">,</span> <span class="n">counter</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="n">Handler</span><span class="o">&lt;</span><span class="n">PingTimeout</span><span class="o">&gt;</span> <span class="n">timeoutHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">PingTimeout</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">PingTimeout</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">trigger</span><span class="o">(</span><span class="k">new</span> <span class="n">TMessage</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">ponger</span><span class="o">,</span> <span class="n">Transport</span><span class="o">.</span><span class="na">TCP</span><span class="o">,</span> <span class="k">new</span> <span class="n">Ping</span><span class="o">()),</span> <span class="n">net</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="o">{</span>
        <span class="n">subscribe</span><span class="o">(</span><span class="n">startHandler</span><span class="o">,</span> <span class="n">control</span><span class="o">);</span>
        <span class="n">subscribe</span><span class="o">(</span><span class="n">pongHandler</span><span class="o">,</span> <span class="n">net</span><span class="o">);</span>
        <span class="n">subscribe</span><span class="o">(</span><span class="n">timeoutHandler</span><span class="o">,</span> <span class="n">timer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tearDown</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">trigger</span><span class="o">(</span><span class="k">new</span> <span class="n">CancelPeriodicTimeout</span><span class="o">(</span><span class="n">timerId</span><span class="o">),</span> <span class="n">timer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PingTimeout</span> <span class="kd">extends</span> <span class="n">Timeout</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="nf">PingTimeout</span><span class="o">(</span><span class="n">SchedulePeriodicTimeout</span> <span class="n">spt</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">spt</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">se.sics.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.ClassMatchedHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.ComponentDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.Positive</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Network</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">se.sics.kompics.network.Transport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ponger</span> <span class="kd">extends</span> <span class="n">ComponentDefinition</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Ponger</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">Positive</span><span class="o">&lt;</span><span class="n">Network</span><span class="o">&gt;</span> <span class="n">net</span> <span class="o">=</span> <span class="n">requires</span><span class="o">(</span><span class="n">Network</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TAddress</span> <span class="n">self</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Ponger</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">self</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">&quot;pingpong.self&quot;</span><span class="o">,</span> <span class="n">TAddress</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">ClassMatchedHandler</span><span class="o">&lt;</span><span class="n">Ping</span><span class="o">,</span> <span class="n">TMessage</span><span class="o">&gt;</span> <span class="n">pingHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassMatchedHandler</span><span class="o">&lt;</span><span class="n">Ping</span><span class="o">,</span> <span class="n">TMessage</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">Ping</span> <span class="n">content</span><span class="o">,</span> <span class="n">TMessage</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">counter</span><span class="o">++;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Got Ping #{}!&quot;</span><span class="o">,</span> <span class="n">counter</span><span class="o">);</span>
            <span class="n">trigger</span><span class="o">(</span><span class="k">new</span> <span class="n">TMessage</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getSource</span><span class="o">(),</span> <span class="n">Transport</span><span class="o">.</span><span class="na">TCP</span><span class="o">,</span> <span class="k">new</span> <span class="n">Pong</span><span class="o">()),</span> <span class="n">net</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="o">{</span>
        <span class="n">subscribe</span><span class="o">(</span><span class="n">pingHandler</span><span class="o">,</span> <span class="n">net</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And of course remember to register <code class="docutils literal notranslate"><span class="pre">TMessage</span></code> to the <code class="docutils literal notranslate"><span class="pre">&quot;netS&quot;</span></code> serialiser in the static initilisation block of <code class="docutils literal notranslate"><span class="pre">Main</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">ClassMatchedHandler</span></code> is in fact only a specialisation of the more general <a class="reference internal" href="../../../javadoc/core/se/sics/kompics/MatchedHandler.html#se.sics.kompics.MatchedHandler" title="se.sics.kompics.MatchedHandler"><code class="xref java java-ref docutils literal notranslate"><span class="pre">se.sics.kompics.MatchedHandler</span></code></a> which can use any kind of pattern to select values, and not just <code class="docutils literal notranslate"><span class="pre">Class</span></code> instances. The advantage of the <code class="docutils literal notranslate"><span class="pre">ClassMatchedHandler</span></code> is that the pattern to match against can be automatically extracted from the signature of the <code class="docutils literal notranslate"><span class="pre">handle</span></code> method using Java’s reflection API. For more general <code class="docutils literal notranslate"><span class="pre">MatchedHandler</span></code> usages the pattern would have to be supplied manually by overriding the <code class="docutils literal notranslate"><span class="pre">pattern</span></code> method.</p>
</div>
</div>
<div class="section" id="assembly">
<h3>Assembly<a class="headerlink" href="#assembly" title="Permalink to this headline">¶</a></h3>
<p>Lastly we finally need to move away from Maven to run our code. We need to able to deploy, configure, and run complete artifacts with all dependencies included. To achieve that goal we are going to need four things:</p>
<blockquote>
<div><ol class="arabic simple">
<li>A Maven <em>assembly</em> plugin,</li>
<li>a <code class="file docutils literal notranslate"><span class="pre">dist</span></code> folder where we collect all deployment artifacts,</li>
<li>an <code class="file docutils literal notranslate"><span class="pre">application.conf`</span></code> in the <code class="file docutils literal notranslate"><span class="pre">dist</span></code> folder that is used to override configuration values from the <code class="file docutils literal notranslate"><span class="pre">reference.conf</span></code> we need to customise for a specific deployment, and</li>
<li>two bash scripts <code class="file docutils literal notranslate"><span class="pre">pinger.sh</span></code> and <code class="file docutils literal notranslate"><span class="pre">ponger.sh</span></code> that hide away the ugly JVM configuration parameters from the users.</li>
</ol>
</div></blockquote>
<p>For the assembly plugin we have two options. Either we use the default <a class="reference external" href="http://maven.apache.org/plugins/maven-assembly-plugin/">Maven Assembly Plugin</a>, which is a bit simpler, or we use <a class="reference external" href="https://maven.apache.org/plugins/maven-shade-plugin/">Maven Shade Plugin</a>, which is a bit more powerful. For the tutorial we are going to use the Shade plugin, as it is usually the better long-term choice.</p>
<p>Our new <code class="file docutils literal notranslate"><span class="pre">pom.xml</span></code> then looks as follows:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>se.sics.test<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>ping-pong<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;name&gt;</span>PingPong<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;description&gt;</span>Ping Pong
    <span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;java.compiler.version&gt;</span>1.7<span class="nt">&lt;/java.compiler.version&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;kompics.version&gt;</span>1.0.0<span class="nt">&lt;/kompics.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>se.sics.kompics<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kompics-core<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${kompics.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>se.sics.kompics.basic<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kompics-port-timer<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${kompics.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>se.sics.kompics.basic<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kompics-component-java-timer<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${kompics.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>se.sics.kompics.basic<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kompics-port-network<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${kompics.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>se.sics.kompics.basic<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kompics-component-netty-network<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${kompics.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>logback-classic<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.2.3<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;inherited&gt;</span>true<span class="nt">&lt;/inherited&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>3.1<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;encoding&gt;</span>${project.build.sourceEncoding}<span class="nt">&lt;/encoding&gt;</span>
                    <span class="nt">&lt;source&gt;</span>${java.compiler.version}<span class="nt">&lt;/source&gt;</span>
                    <span class="nt">&lt;target&gt;</span>${java.compiler.version}<span class="nt">&lt;/target&gt;</span>
                    <span class="nt">&lt;debug&gt;</span>true<span class="nt">&lt;/debug&gt;</span>
                    <span class="nt">&lt;optimize&gt;</span>true<span class="nt">&lt;/optimize&gt;</span>
                    <span class="nt">&lt;showDeprecations&gt;</span>true<span class="nt">&lt;/showDeprecations&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-shade-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>2.4.2<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;executions&gt;</span>
                    <span class="nt">&lt;execution&gt;</span>
                        <span class="c">&lt;!--&lt;phase&gt;package&lt;/phase&gt;//--&gt;</span>
                        <span class="nt">&lt;goals&gt;</span>
                            <span class="nt">&lt;goal&gt;</span>shade<span class="nt">&lt;/goal&gt;</span>
                        <span class="nt">&lt;/goals&gt;</span>
                        <span class="nt">&lt;configuration&gt;</span>
                            <span class="nt">&lt;minimizeJar&gt;</span>true<span class="nt">&lt;/minimizeJar&gt;</span>
                            <span class="nt">&lt;shadedArtifactAttached&gt;</span>true<span class="nt">&lt;/shadedArtifactAttached&gt;</span>
                            <span class="nt">&lt;shadedClassifierName&gt;</span>fat<span class="nt">&lt;/shadedClassifierName&gt;</span>
                            <span class="c">&lt;!-- Any name that makes sense --&gt;</span>
                            <span class="nt">&lt;createDependencyReducedPom&gt;</span>true<span class="nt">&lt;/createDependencyReducedPom&gt;</span>
                            <span class="nt">&lt;dependencyReducedPomLocation&gt;</span>${java.io.tmpdir}/dependency-reduced-pom.xml
                    <span class="nt">&lt;/dependencyReducedPomLocation&gt;</span>
                            <span class="nt">&lt;transformers&gt;</span>
                                <span class="nt">&lt;transformer</span> <span class="na">implementation=</span><span class="s">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;mainClass&gt;</span>se.sics.test.Main<span class="nt">&lt;/mainClass&gt;</span>
                                <span class="nt">&lt;/transformer&gt;</span>
                            <span class="nt">&lt;/transformers&gt;</span>
                            <span class="nt">&lt;filters&gt;</span>
                                <span class="nt">&lt;filter&gt;</span>
                                    <span class="nt">&lt;artifact&gt;</span>log4j:log4j<span class="nt">&lt;/artifact&gt;</span>
                                    <span class="nt">&lt;includes&gt;</span>
                                        <span class="nt">&lt;include&gt;</span>**<span class="nt">&lt;/include&gt;</span>
                                    <span class="nt">&lt;/includes&gt;</span>
                                <span class="nt">&lt;/filter&gt;</span>
                                <span class="nt">&lt;filter&gt;</span>
                                    <span class="nt">&lt;artifact&gt;</span>commons-logging:commons-logging<span class="nt">&lt;/artifact&gt;</span>
                                    <span class="nt">&lt;includes&gt;</span>
                                        <span class="nt">&lt;include&gt;</span>**<span class="nt">&lt;/include&gt;</span>
                                    <span class="nt">&lt;/includes&gt;</span>
                                <span class="nt">&lt;/filter&gt;</span>
                            <span class="nt">&lt;/filters&gt;</span>
                        <span class="nt">&lt;/configuration&gt;</span>
                    <span class="nt">&lt;/execution&gt;</span>
                <span class="nt">&lt;/executions&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;snapshots&gt;</span>
                <span class="nt">&lt;enabled&gt;</span>false
            <span class="nt">&lt;/enabled&gt;</span>
            <span class="nt">&lt;/snapshots&gt;</span>
            <span class="nt">&lt;id&gt;</span>bintray-kompics-Maven
          <span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>bintray
          <span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://dl.bintray.com/kompics/Maven
          <span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
<p>After we create the new <code class="file docutils literal notranslate"><span class="pre">dist</span></code> folder and move the new shaded fat jar from the <code class="file docutils literal notranslate"><span class="pre">target</span></code> folder into it, we create the two scripts and the <code class="file docutils literal notranslate"><span class="pre">application.conf</span></code> such that the content is as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ls -ohn
<span class="go">total 9984</span>
<span class="go">-rw-r--r--  1 501   165B Dec 26 18:43 application.conf</span>
<span class="go">-rw-r--r--  1 501   4.9M Dec 26 18:28 ping-pong-1.0-SNAPSHOT-fat.jar</span>
<span class="go">-rwxr-xr-x  1 501    93B Dec 26 18:35 pinger.sh</span>
<span class="go">-rwxr-xr-x  1 501    93B Dec 26 18:33 ponger.sh</span>
</pre></div>
</div>
<p>Note the <em>executable</em> flag set on the bash scripts. Now write the following into the newly created files.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">application.conf</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">pingpong.self.host = &quot;&quot; // insert self hostname</span>
<span class="l l-Scalar l-Scalar-Plain">// pinger only</span>
<span class="l l-Scalar l-Scalar-Plain">pingpong.pinger.pongeraddr.host = &quot;&quot; // insert target hostname</span>
<span class="l l-Scalar l-Scalar-Plain">pingpong.pinger.pongeraddr.port = 34567</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">ponger.sh</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

java -Dconfig.file<span class="o">=</span>./application.conf -jar ping-pong-1.0-SNAPSHOT-fat.jar ponger
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">pinger.sh</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

java -Dconfig.file<span class="o">=</span>./application.conf -jar ping-pong-1.0-SNAPSHOT-fat.jar pinger
</pre></div>
</div>
</div>
<p>And now simply pack up the <code class="file docutils literal notranslate"><span class="pre">dist</span></code> folder and distribute it to two machines that are connected via the network, unpack and fill in the necessary fields in <code class="file docutils literal notranslate"><span class="pre">application.conf</span></code> on both machines.</p>
<p>Finally, start first the ponger with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./ponger.sh</span>
</pre></div>
</div>
<p>And then the pinger:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./pinger.sh</span>
</pre></div>
</div>
<p>As always the final code can be downloaded <a class="reference download internal" download="" href="../../../_downloads/69ad0b8e3b20f85f256f2e1654032c26/pingpong-cleaner.zip"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course the bash files only work on *nix machines. If you need this to run on Windows, you’ll either have to write <code class="docutils literal notranslate"><span class="pre">.bat</span></code> files or use one of the application packaging tools that generate <code class="docutils literal notranslate"><span class="pre">.exe</span></code> files from <code class="docutils literal notranslate"><span class="pre">.jar</span></code> files and you’ll have to fix all the paths.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../virtual/virtual.html" class="btn btn-neutral float-right" title="Virtual Networks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="Networking" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, SICS Swedish ICT and KTH Royal Institute of Technology

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>